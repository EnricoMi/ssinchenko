<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/ssinchenko/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=ssinchenko/livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Extending Spark Connect | Sem Sinchenko</title>
<meta name="keywords" content="spark, pyspark, spark-connect">
<meta name="description" content="This blog post presents a very detailed step-by-step guide on how to create a SparkConnect protocol extension in Java and call it from PySpark. It will also cover a topic about how to define all the necessary proto3 messages for it. At the end of this guide you will have a way to interact with Spark JVM from PySpark almost like you can with py4j in a non-connect version.">
<meta name="author" content="Sem Sinchenko">
<link rel="canonical" href="http://localhost:1313/ssinchenko/post/extending-spark-connect/">
<link crossorigin="anonymous" href="/ssinchenko/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css" integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z&#43;V9&#43;cO1A=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/ssinchenko/images/fav/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/ssinchenko/images/fav/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/ssinchenko/images/fav/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/ssinchenko/images/fav/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/ssinchenko/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/ssinchenko/post/extending-spark-connect/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
















    
        <link rel="preconnect" href="https://plausible.io">
    <!-- Dev mode : We do not load plausible script to avoid bloating your stats -->

<!-- If you are using Content-Security-Policy, do not forget to add this code to your CSP : 
  script-src 'unsafe-inline' https://plausible.io
  connect-src 'unsafe-inline' https://plausible.io
  or just add the partial 'plausible_csp.html' to those 2 csp directives in your 'index.headers' file
-->



    
    <script>window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }</script>
    <script>
         
         
         
    </script>

    

  

<meta property="og:title" content="Extending Spark Connect" />
<meta property="og:description" content="This blog post presents a very detailed step-by-step guide on how to create a SparkConnect protocol extension in Java and call it from PySpark. It will also cover a topic about how to define all the necessary proto3 messages for it. At the end of this guide you will have a way to interact with Spark JVM from PySpark almost like you can with py4j in a non-connect version." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/ssinchenko/post/extending-spark-connect/" />
<meta property="og:image" content="https://upload.wikimedia.org/wikipedia/commons/f/f3/Apache_Spark_logo.svg" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2024-03-04T12:30:57+01:00" />
<meta property="article:modified_time" content="2024-03-04T12:30:57+01:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://upload.wikimedia.org/wikipedia/commons/f/f3/Apache_Spark_logo.svg" />
<meta name="twitter:title" content="Extending Spark Connect"/>
<meta name="twitter:description" content="This blog post presents a very detailed step-by-step guide on how to create a SparkConnect protocol extension in Java and call it from PySpark. It will also cover a topic about how to define all the necessary proto3 messages for it. At the end of this guide you will have a way to interact with Spark JVM from PySpark almost like you can with py4j in a non-connect version."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/ssinchenko/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Extending Spark Connect",
      "item": "http://localhost:1313/ssinchenko/post/extending-spark-connect/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Extending Spark Connect",
  "name": "Extending Spark Connect",
  "description": "This blog post presents a very detailed step-by-step guide on how to create a SparkConnect protocol extension in Java and call it from PySpark. It will also cover a topic about how to define all the necessary proto3 messages for it. At the end of this guide you will have a way to interact with Spark JVM from PySpark almost like you can with py4j in a non-connect version.",
  "keywords": [
    "spark", "pyspark", "spark-connect"
  ],
  "articleBody": "Preface I would like to thank Martin Grund. He gave me a lot of useful advice during my work on this project!\nIntroduction Recently, I published a post about potential compatibility issues between SparkConnect and 3d-party libraries that depend on py4j. After that post, people from Databricks contacted me and suggested we work together on this issue. With their help, I tried to create a step-by-step guide for newbies on how to extend SparkConnect and how to potentially migrate from py4j logic to writing protocol plugins.\nWhat is going on? As you may know, Apache Spark 4.0 is coming. And it looks like the SparkConnect protocol will be the main way of communication between the driver and the user’s code. So we need to be ready for it. But there are still a lot of 3d party libraries based on Java/Scala core and PySpark bindings via py4j. There is also a gap in the Apache Spark documentation on how to extend the protocol, what are the best practices, and how to migrate your project to a new way of working.\nWhat is Spark Connect For anyone new to the topic, SparkConnect is a new modern way to make Apache Spark a little more “modular”. Instead of creating a Driver directly in the user’s code, we create a Driver in a remote SparkConnect server. All communication between the client and such a server is done via the gRPC protocol. This opens a lot of interesting possibilities, such as\nEasy creation of new language APIs, for example the recently introduced Go Spark Client; Better user isolation when working on shared clusters (like Databricks Shared Clusters); Reduced dependency hell because users do not have to check all Spark internal dependencies and only need a thin client; Spark Connect Architecture For a top-level overview, you can check out an Overview in Spark Documentation. For a deeper dive into the topic I recommend this nice blog post by Bartosz Konieczny or the video of Martin Grund’s presentation:\nHow the post is organized The first section will briefly describe how to get and configure everything you need to test a SparkConnect application. Like getting Spark itself, building it from source, fixing some bugs, etc. We will also touch on all the prerequisites needed to build an application: Java, Maven, Python, protobuf, buf, etc; After that, we will briefly touch on the basic structures provided by Spark for extending the protocol: CommandPlugin, RelationPlugin, ExtensionPlugin; Next, we will define the JVM library that we want to wrap in the SparkConnect extension; After that, we will write all the necessary protocol extensions; The next step is to create a Python client; Finally, the end2end testing of the application; At the end I will try to say a few words about what is good in a new SparkConnect and what is missing from my point of view. Setup In this project I will use Java instead of Scala. The reason is quite simple: in my understanding, any Scala dev can read Java code. But it does not always work well in the other direction just because of Scala magic and implicity. Of course, the same code will look more elegant in Scala, but since this is a blog post, readability should be the first priority. I will also use Maven as a build system, simply because Apache Spark itself uses this build tool.\nBefore we start, you will need the following\nJava 17: Archive or install it through your system package manager or use SDKMan; Python 3.10: Archive or install it via the system package manager or use PyEnv; Maven: Download page or install it via the system package manager; Protobuf: Release Page, but it is better to install it via the system package manager; Buf: GitHub repo. Build the latest Spark The main reason to work directly with the latest Spark snapshot is that while the Spark Connect general implementation is readily available since Spark 3.4 for Python and Spark 3.5 for Scala, there is still a lot of work in progress to reduce sharp edges and improve documentation.\nWe need to work with a latest available spark-4.0.0-SNAPSHOT version. At first you need to clone it locally via git clone git@github.com:apache/spark.git. After that just go inside and call mvn ./build/mvn -Pconnect clean package. The next step is to generate corresponding PySpark library: cd python; python3.10 setup.py sdist. It will generate something like pyspark-4.0.0.dev0.tar.gz in dist folder. It is a ready to use distribution that may be installed into user’s environment.\nA JVM library example Our goal will be to try to wrap some existing Spark-Java logic that manipulates by instances of DataFrame class and also by own classes. Of course, at first, we need to define such a library first!\nCommand Logic The simplest of all the possible cases is just a command. In the world of Spark Connect, a command is a simple way to invoke server-side logic that might incur a side-effect and does not necessarily return data. On the JVM-side it should be represented by public void command(A argA, B argB, ...). For example, it may be the case when we need to initialize library classes by something like public void init(). Another case is when we want to write something to the FileSystem. Let’s try to mimic such a case:\npublic class CommandLikeLogic { public static void commandA(Long paramA, Long paramB, String paramC) throws IOException { var spark = SparkSession.active(); var path = new Path(paramC); var fs = path.getFileSystem(spark.hadoopConf()); var outputStream = fs.create(path); outputStream.writeUTF(String.format(\"FieldA: %d\\nFieldB: %d\", paramA, paramB)); outputStream.flush(); outputStream.close(); } } It is a very dummy class with just a single method commandA(Long paramA, Long paramB, String paramC). It do the following:\nGet a current active SparkSession object; Get a right implementation of org.apache.hadoop.fs.FileSystem based on the configuration from the SparkSession; Write values of paramA and paramB into a file in path defined by paramC As one may see there is no magic. But working with underlying org.apache.hadoop.fs.FileSystem is not possible from PySpark and it is very common case to write such a logic in JVM-languages!\nDataFrame Logic Another case is when JVM-object should create and return DataFrame (Dataset) object. It is the most common case for any kind of 3d-party library. From my experience developers typically work-around such a logic via py4j:\nDataFrame in PySpark has a private attribute _jdf that represents py4j.java_gateway.JavaObject corresponds to Dataset in JVM; DataFrame in PySaprk has a constructor that takes py4j.java_gateway.JavaObject and SparkSession and returns pyspark.sql.DataFrame; With SparkConnect this workaround doesn’t work anymore, so let’s see how we may do it in a new and right way. Let’s try to wrap the following simple class:\npublic class DataFrameLogic { public static Dataset\u003cRow\u003e createDummyDataFrame() { var schema = new StructType( new StructField[] { DataTypes.createStructField(\"col1\", DataTypes.LongType, true), DataTypes.createStructField(\"col2\", DataTypes.StringType, true), DataTypes.createStructField(\"col3\", DataTypes.BooleanType, true) }); var spark = SparkSession.active(); var rows = new ArrayList\u003cRow\u003e(); var gen = new Random(); for (int i = 0; i \u003c= 10; i++) { rows.add( RowFactory.create( gen.nextLong(), String.format(\"%d-%d\", gen.nextInt(), gen.nextLong()), gen.nextBoolean())); } return spark.createDataFrame(rows, schema); } } As one may see it is a really dummy object. And, of course, you can do exactly the same in pure PySpark (doesn’t matter, with SparkConnect or not). But let’s still try to wrap it just to understand how it works. In this case this simple class should be enough for our purposes. In the world of Spark Connect, this DataFrame logic is represented by Relation messages. These messages are declarative transformations that can be arbitrarily nested and are very similar to the standard Spark SQL operations like project, filter, groupBy.\nManipulation of JVM objects The most complex and tricky thing is when we need not only call void commands or create/modify DataFrame objects, but create instances of regular JVM classes and calls methods of them. To mimic such a case let’s again create a dummy Java class with couple of getter/setter methods, constructor and, for example, custom toString() implementation:\npublic class ObjectManipulationLogic { private String strParameter; private Long longParameter; public ObjectManipulationLogic(String strParameter, Long longParameter) { this.strParameter = strParameter; this.longParameter = longParameter; } public String getStrParameter() { return strParameter; } public void setStrParameter(String strParameter) { this.strParameter = strParameter; } public Long getLongParameter() { return longParameter; } public void setLongParameter(Long longParameter) { this.longParameter = longParameter; } @Override public String toString() { return \"ObjectManipulationLogic{\" + \"strParameter='\" + strParameter + '\\'' + \", longParameter=\" + longParameter + '}'; } } Our class has a public constructor just for simplicity. In reality, of course, it could be more complex with factory methods. But it should be enough for our demo case.\nOur class has two fields, corresponding getters/setters, and a custom `toString’. In reality, of course, no one will wrap complex JVM logic in SparkConnect. But as you will see in the next sections, there is no fundamental difference in which method is called. So such a class is complex enough for our demo purposes.\nDefining protobuf messages At first, to start any kind of SparkConnect extending we need to define contracts in the form of protobuf messages that are interpreted by Spark. We decided to use the following three use-cases:\nCalling a command; Creating a DataFrame; Manipulating JVM object. syntax = 'proto3'; option java_multiple_files = true; option java_package = \"com.ssinchenko.example.proto\"; message CallCommandLikeLogic { int64 paramA = 1; int64 paramB = 2; string paramC = 3; } message CallDataFrameLogic {} message CallObjectManipulationLogic { int32 objectId = 1; bool newObject = 2; bool deleteObject = 3; string methodName = 4; repeated string args = 5; } Let’s go step by step.\nThe first rows tels us to use proto3 (protobuf version 3) syntax, which package is it, which java package is it, etc. There is no special magic, so, just use it as an example for your Spark proto code.\nmessage CallCommandLikeLogic { int64 paramA = 1; int64 paramB = 2; string paramC = 3; } This message will be used to call a CommandLikeLogic Java class. As you remember, the only static method commandA takes exactly three arguments (Long paramA, Long paramB, String paramC). In protobuf syntax it transforms into int64 paramA, int64 paramB and string paramC. Numbers in proto-syntax means the id of argument in the message, you can read more about it in the protobuf documentation.\nThe message for CallDataFrameLogic is even simpler: it is just an empty one, but we still need it for checking the appropriate command.\nThe last message is quite tricky. To manipulate objects in JVM via gRPC we need at least the following:\nAn ID of the object just to know which one should we touch in JVM; A flag that we need to create a new object instead of manipulating existing one; A flag that we need to delete an existing object; A name of the method we want to call (in the case when we do not want to delete or create an object); A list of strings-represented arguments; And it gain us the structure of the CallObjectManipulationLogic message:\nmessage CallObjectManipulationLogic { int32 objectId = 1; bool newObject = 2; bool deleteObject = 3; string methodName = 4; repeated string args = 5; } Because in proto3 syntax any argument is optional we do not need to mark fields as optional or required. So, all the checking logic is moving to runtime.\nGenerating Classes and Methods from proto-code Now we need to generate corresponding Java classes and methods based on the proto3 code. Of course you can use something like protoc -I=... -java_out=... .... But it is not the simplest way. To make it simpler there is a very cool tool named buf (link to the buf repo in GitHub). I already mentioned this tool in previous sections. With buf generation for all the languages may be done via one command: buf generate. But at first we need to define buf.work.yaml and buf.gen.yaml that should contain the information about which plugins we want to use.\nbuf.work.yaml:\nversion: v1 directories: - protobuf buf.gen.yaml:\nversion: v1 plugins: - plugin: buf.build/protocolbuffers/python:v25.3 out: python/spark_connect_example/proto - plugin: buf.build/grpc/python:v1.62.0 out: python/spark_connect_example/proto - plugin: buf.build/community/nipunn1313-mypy:v3.5.0 out: python/spark_connect_example/proto - plugin: buf.build/protocolbuffers/java:v25.3 out: java NOTE: You may find a list of available buf plugins here.\nThe first one defines the protobuf files directory, the second one defines what should be generated and also where this files should be places. Let’s again see on the structure of the project to better understand what’s going on:\n|- src |-- main |--- java |---- com/ssinchenko/example |----- lib |----- proto # \u003c- generated from proto Java classes will be here |----- server |--- protobuf # \u003c- proto3 code is here |--- python |---- spark_connect_example |----- proto # \u003c- generated from proto Python classes will be here |---- pyproject.toml |--- buf.gen.yaml |--- buf.work.yaml |- pom.xml So, long story short, all that you need from now to generate (or regenerate) all the classes/py-files is to call buf generate from the src/main directory.\nCommandPlugin As I mention already, the case of void command is the simplest one. Let’s see how implementation of the CommandPlugin will look for the case of our CommandLikeLogic class:\npublic class CommandLikeLogicPlugin implements CommandPlugin { @Override public boolean process(byte[] command, SparkConnectPlanner planner) { Any commandProto; try { commandProto = Any.parseFrom(command); } catch (InvalidProtocolBufferException e) { throw new RuntimeException(e); } if (commandProto.is(CallCommandLikeLogic.class)) { try { var message = commandProto.unpack(CallCommandLikeLogic.class); CommandLikeLogic.commandA(message.getParamA(), message.getParamB(), message.getParamC()); } catch (IOException e) { return false; } } return true; } } NOTE: In this case CallCommandLikeLogic is exactly the generated by buf class. It contains more than 500 lines of Java code, so I cannot put it here. But you may generate your own to see how it looks like!\nLet’s in details on the syntax.\nimplements CommandPlugin is just about which interface should we implement; we always gets byte[] as an input; you may check it the spark source code; Any in this case not just any class, but proto.Any: link to rest API documentation; planner is a spark internal tool that contains a lot of useful things, including SparkSession itself: var = planner.sessionHolder().session();; command.is(...) verifies that the embedded message types is of the class we expect; command.unpack(...) unpack the command into an actual generated Class with methods; finally we just call our method from out JVM “library” like class. RelationPlugin A more tricky case is when we need to return DataFrame. For that case we need to implement RelationPlugin. It requires to override a method transform:\npublic class DataFrameLogicPlugin implements RelationPlugin { @Override public Optional\u003cLogicalPlan\u003e transform(byte[] relation, SparkConnectPlanner planner) { Any relationProto; try { relationProto = Any.parseFrom(relation); } catch (InvalidProtocolBufferException e) { throw new RuntimeException(e); } if (relationProto.is(CallDataFrameLogic.class)) { return Optional.of(DataFrameLogic.createDummyDataFrame().logicalPlan()); } return Optional.empty(); } } As one may see it is quite similar to command but instead of boolean we need to return an Optional. On the JVM side you can easily get this plan by just calling df.logicalPlan() and that’s it.\nNOTE: You only need to return Optional.empty if the command is not for this handler! In all other cases you must either throw an exception or return an actual LogicalPlan!\nObjects Manipulation The most advanced case is when we want to manipulate an object on the JVM side, as it can be done before with py4j. It is a little tricky because we can only use LogicalPlan for interaction between JVM and client! To implement this thing I will use the following:\nI will use HashMap to map all objects to integer IDs; To generate an ID of the object I will use System.identifyHashCode(obj); All communication with the client will be done via LogicalPlan, even error messages can be transported this way; Inside I will parse an input message and call create, delete object or call methods; To simplify things, I based my code on the assumption that there may be only 100 objects, or that arguments passed by the client are always correct. And of course I have not touched the topic of ID collision. But you can extend this code to achieve all of the above. My goal was just to create a kind of proof of concept, nothing more!\npublic class ObjectManipulationLogicPlugin implements RelationPlugin { /** This is a map, that stores link to all the objects. */ private static final HashMap\u003cInteger, ObjectManipulationLogic\u003e idsMapping = new HashMap\u003c\u003e(100); public static ObjectManipulationLogic getObj(Integer id) { return idsMapping.get(id); } public static Integer addObj(ObjectManipulationLogic obj) { var id = System.identityHashCode(obj); idsMapping.put(id, obj); return id; } public static void update(Integer id, ObjectManipulationLogic obj) { idsMapping.put(id, obj); } public static void dropObj(Integer id) { idsMapping.remove(id); } private Dataset\u003cRow\u003e getSuccessDF(SparkSession spark) { return spark.createDataFrame( List.of(RowFactory.create(\"success\")), new StructType( new StructField[] { DataTypes.createStructField(\"status\", DataTypes.StringType, false) })); } @Override public Optional\u003cLogicalPlan\u003e transform(byte[] relation, SparkConnectPlanner planner) { // To make the code simpler I'm not checking type of passed from Python arguments! // So, the overall logic is build on the assumption, that it is impossible to get // from python an invalid string or invalid long. // // It makes sense, because it is x10 simpler to do it on the Python side Any relationProto; try { relationProto = Any.parseFrom(relation); } catch (InvalidProtocolBufferException e) { throw new RuntimeException(e); } if (relationProto.is(CallObjectManipulationLogic.class)) { var spark = planner.sessionHolder().session(); try { // We are parsing the message var message = relationProto.unpack(CallObjectManipulationLogic.class); if (message.getNewObject()) { // If we need to create a new object we are doing the following: // 1. Get args // 2. Create an instance // 3. Add an id of the instance to the Map // 4. Return the id to Python var args = message.getArgsList(); var paramA = args.get(0); var paramB = Long.parseLong(args.get(1)); var instance = new ObjectManipulationLogic(paramA, paramB); var id = ObjectManipulationLogicPlugin.addObj(instance); var df = spark.createDataFrame( List.of(RowFactory.create(id)), new StructType( new StructField[] { DataTypes.createStructField(\"id\", DataTypes.IntegerType, false) })); return Optional.of(df.logicalPlan()); } else if (message.getDeleteObject()) { // If we need to drop the object we just delete it from the Map // After that GC will do it's work. var id = message.getObjectId(); ObjectManipulationLogicPlugin.dropObj(id); return Optional.empty(); } else { // All other cases is when we need to call a method var methodName = message.getMethodName(); var args = message.getArgsList(); var id = message.getObjectId(); var instance = ObjectManipulationLogicPlugin.getObj(id); // Possible to do the same via Reflection API; // But to achieve explicitly I'm directly check the method name. // We need to know types anyway, to return a DataFrame with a right schema. // So, we are checking all the possible methods and do the following: // 1. If it is setter than just parse args and modify the obj // 2. If it is getter or toString we just wrap the output into DataFrame switch (methodName) { case \"getStrParameter\" -\u003e { var df = spark.createDataFrame( List.of(RowFactory.create(instance.getStrParameter())), new StructType( new StructField[] { DataTypes.createStructField(\"strParameter\", DataTypes.StringType, false) })); return Optional.of(df.logicalPlan()); } case \"getLongParameter\" -\u003e { var df = spark.createDataFrame( List.of(RowFactory.create(instance.getLongParameter())), new StructType( new StructField[] { DataTypes.createStructField(\"longParameter\", DataTypes.LongType, false) })); return Optional.of(df.logicalPlan()); } case \"setStrParameter\" -\u003e { instance.setStrParameter(args.get(0)); update(id, instance); return Optional.of(getSuccessDF(spark).logicalPlan()); } case \"setLongParameter\" -\u003e { instance.setLongParameter(Long.parseLong(args.get(0))); update(id, instance); return Optional.of(getSuccessDF(spark).logicalPlan()); } case \"toString\" -\u003e { var df = spark.createDataFrame( List.of(RowFactory.create(instance.toString())), new StructType( new StructField[] { DataTypes.createStructField( \"stringRepresentation\", DataTypes.StringType, false) })); return Optional.of(df.logicalPlan()); } default -\u003e { var df = spark.createDataFrame( List.of( RowFactory.create(String.format(\"Invalid method name %s\", methodName))), new StructType( new StructField[] { DataTypes.createStructField(\"errorMessage\", DataTypes.StringType, false) })); return Optional.of(df.logicalPlan()); } } } } catch (IOException e) { // In the case of error we are just wrapping the error message to DataFrame var sw = new StringWriter(); var pw = new PrintWriter(sw); e.printStackTrace(pw); var df = spark.createDataFrame( List.of(RowFactory.create(String.format(\"IOException %s\", sw))), new StructType( new StructField[] { DataTypes.createStructField(\"errorMessage\", DataTypes.StringType, false) })); return Optional.of(df.logicalPlan()); } } // That is the case when the message corresponds to another plugin/extension. return Optional.empty(); } } Build the project To build the project it is enough just to call mvn clean package and it will create an artifcat like this connect-1.0-SNAPSHOT.jar. Of course, in assumption, that you are using the code of my example from GitHub repository!\nSparkConnect Plugins in Python To setup all the dependencies do the following:\nMake SPARK_HOME variable points to the place where gou cloned spark. In my case it is export SPARK_HOME=~/github/spark; In you python project (in my repo it is src/main/python) create virtual environment: python3.10 -m venv .venv; Install pyspark dependencies: source .venv/bin/activate \u0026\u0026 pip install -r ${SPARK_HOME}/dev/requirements.txt; Install pyspark itself: source .venv/bin/activate \u0026\u0026 pip install ${SPARK_HOME}/python/dist/pyspark-4.0.0.dev0.tar.gz. It should be enough to run my example and to make autocomplete works.\nImplementation in Python If you did not generate needed python-classes that implements protobuf Messages, you can easily do it via buf generate (from src/main).\nThe next step is to implement a gRPC client.\nCallCommand Each message kind should be implemented as a separate Python class that inherit from pyspark.sql.connect.plan.LogicalPlan. For command you need to override the command method:\nclass CallCommandPlan(LogicalPlan): def __init__(self, param_a: int, param_b: int, param_c: str) -\u003e None: super().__init__(None) self._a = param_a self._b = param_b self._c = param_c def command(self, session: SparkConnectClient) -\u003e proto.Command: command = proto.Command() command.extension.Pack(CallCommandLikeLogic(paramA=self._a, paramB=self._b, paramC=self._c)) return command And after that you can create a function that uses this class. Remember that even if it is just a Command, you still need to call an action on the returned DataFrame!\ndef call_command(a: int, b: int, file_name: str, spark: SparkSession) -\u003e None: print(file_name) DataFrame(CallCommandPlan(a, b, file_name), spark).collect() CallDataFrame The next in a row is a dummy function that generates DataFrame:\nclass CallDataFrameLogicPlan(LogicalPlan): def __init__(self) -\u003e None: super().__init__(None) def plan(self, session: SparkConnectClient) -\u003e proto.Relation: plan = self._create_proto_relation() ext = CallDataFrameLogic() plan.extension.Pack(ext) return plan def create_dataframe_extension(spark: SparkSession) -\u003e DataFrame: return DataFrame(CallDataFrameLogicPlan(), spark) Almost like a Command but now you need to override plan method, not command.\nObjects Manipulation The most tricky part. As you remember, we used IDs in JVM side to provide a way of interacting between client and java-object. But before we implement a Python wrapper on top of Java object we need to create a LogicalPlan extension:\nclass CallObjectManipulationPlan(LogicalPlan): def __init__( self, object_id: int = 0, new_object: bool = False, delete_object: bool = False, method_name: str = \"\", jargs: list[str] | None = None, ) -\u003e None: if jargs is None: jargs = [] super().__init__(None) self._object_id = object_id self._new_object = new_object self._delete_object = delete_object self._method_name = method_name self._jargs = jargs def plan(self, session: SparkConnectClient) -\u003e proto.Relation: plan = self._create_proto_relation() ext = CallObjectManipulationLogic( objectId=self._object_id, newObject=self._new_object, deleteObject=self._delete_object, methodName=self._method_name, args=self._jargs, ) plan.extension.Pack(ext) return plan This class is very similar to our dummy CallDataFrameLogicPlan but not we have an actual constructor with fields.\nLet’s see, how the Python class corresponds to the Java class may be written:\nclass JavaLikeObject: def __init__(self, param_a: str, param_b: int, spark: SparkSession) -\u003e None: query_plan = CallObjectManipulationPlan( new_object=True, jargs=[param_a, str(param_b)] ) df = DataFrame(query_plan, spark) if \"errorMessage\" in df.columns: err_msg = df.collect()[0].asDict().get(\"errorMessage\", \"\") raise ValueError(err_msg) obj_id = df.collect()[0].asDict().get(\"id\", -1) self._id = obj_id self._spark = spark def get_str_parameter(self) -\u003e str: query_plan = CallObjectManipulationPlan( object_id=self._id, method_name=\"getStrParameter\" ) return ( DataFrame(query_plan, self._spark) .collect()[0] .asDict() .get(\"strParameter\", \"\") ) def get_long_parameter(self) -\u003e int: query_plan = CallObjectManipulationPlan( object_id=self._id, method_name=\"getLongParameter\" ) return ( DataFrame(query_plan, self._spark) .collect()[0] .asDict() .get(\"longParameter\", -1) ) def set_str_parameter(self, str_par: str) -\u003e None: query_plan = CallObjectManipulationPlan( object_id=self._id, method_name=\"setStrParameter\", jargs=[str_par] ) DataFrame(query_plan, self._spark).collect() def set_long_parameter(self, long_par: int) -\u003e None: query_plan = CallObjectManipulationPlan( object_id=self._id, method_name=\"setLongParameter\", jargs=[str(long_par)], ) DataFrame(query_plan, self._spark).collect() def to_string(self) -\u003e str: query_plan = CallObjectManipulationPlan( object_id=self._id, method_name=\"toString\" ) return ( DataFrame(query_plan, self._spark) .collect()[0] .asDict() .get(\"stringRepresentation\", \"\") ) def delete(self) -\u003e None: query_plan = CallObjectManipulationPlan( object_id=self._id, delete_object=True ) DataFrame(query_plan, self._spark) Here we just cover each of possible method in Java in the corresponding Python method.\nEnd2end demo Let’s check the most interesting part: objects manipulation. To do we need to create a main.py file:\nfrom pyspark.sql.connect.session import SparkSession from spark_connect_example.app_plugin import JavaLikeObject if __name__ == \"__main__\": spark = SparkSession.builder.remote(\"sc://localhost:15002\").getOrCreate() # Creating an object java_like = JavaLikeObject(param_a=\"some\", param_b=100, spark=spark) # Call setter java_like.set_str_parameter(\"some\") # Call setter java_like.set_long_parameter(1) # Call getter print(java_like.get_long_parameter()) # Call setter again java_like.set_long_parameter(2) # Check that getter returns a new value print(java_like.get_long_parameter()) # Call toString print(java_like.to_string()) Running SparConnect server Now we need to do some manipulations in the folder where we cloned spark. For me it was ~/github/spark. Or just do something like cd $SPARK_HOME.\nBefore we can actually check this, we need to have the SparkConnect server up and running. For some unknown reason, a recommended way to build Spark with connect support did not add the Java protobuf library to CP. To fix this, I just got it from Maven Central: wget https://repo1.maven.org/maven2/com/google/protobuf/protobuf-java/3.22.0/protobuf-java-3.22.0.jar.\nWe also need to copy the built connect-1.0-SNAPSHOT.jar into the same folder as spark. Finally, we need to execute a very long command, so it is better to create a short bash script for it:\n./sbin/start-connect-server.sh \\ --wait \\ --verbose \\ --jars connect-1.0-SNAPSHOT.jar,protobuf-java-3.22.0.jar \\ --conf spark.connect.extensions.command.classes=com.ssinchenko.example.server.CommandLikeLogicPlugin \\ --conf spark.connect.extensions.relation.classes=com.ssinchenko.example.server.DataFrameLogicPlugin,com.ssinchenko.example.server.ObjectManipulationLogicPlugin \\ --packages org.apache.spark:spark-connect_2.13:4.0.0-SNAPSHOT Let’s see it in details:\n--wait means to wait for the process to exit. Otherwise SparkConnect will run in background; --verbose just add some additional debug information; --jars: we need to pass here our connect-1.0-SNAPSHOT.jar. In my case it was necessary to pass also protobuf-java; --conf spark.connect.extensions.relation.classes=...: we should mention here all the plugins for relations; --conf spark.connect.extensions.relation.classes: the same, but for commands; --packages org.apache.spark:spark-connect_2.13:4.0.0-SNAPSHOT: just tell spark what to run. To run the server, just run the bash script we just made. Another way is to copy this long command into you terminal.\nRunning an application After running the server, just go back to our src/main/python and run the command source .venv/bin/activate \u0026\u0026 python main.py. You will see something like:\n1 2 ObjectManipulationLogic{strParameter='some', longParameter=2} NOTE: To see detailed logs from python side, use export SPARK_CONNECT_LOG_LEVEL=debug\nAnyway, as you can see, our workaround to call JVM from PySpark-connect thin client works!\n🥳🥳🥳🥳🥳🥳🥳🥳\nDiscussion What was cool? I found that having a built-in way to serialize and deserialize LogicalPlan is very cool! It opens up a lot of possibilities for what you can do with SparkConnect! By packing everything into DataFrame and unpacking it on the client side, you can pass almost anything. I guess you could even serialize code into binary format and pack it into DataFrame. Of course, this might look a little crazy, but no more crazy than the magic of py4j!\nWhat seems to be missing Test environment There is no easy way to test your application against SparkConnect. You always have to get binaries, and that is not cool. Even if you need to work with the 3.5.x version, you always have to download both binaries and PySpark, which means you download all jar files twice. It would be very cool if we had a simpler way.\nError messages Error messages from SparkConnect are still sometimes not informative enough. For example, you might get something like org.apache.spark.sql.connect.common.InvalidPlanInput: No handler found for extension and it is not at all obvious what the reason is and on which message it happened. Is the problem in the Java plugin implementation? Or maybe there is a problem in the Python serialization? Or is it just a missing plugin class in CP? Unfortunately, you have to check all these cases, because the error message says almost nothing.\nAfterword I hope my example will help you in your research and development!\nP.S. If you find this guide useful, it is not necessary to buy me coffee or anything like that. Just go and star the corresponding repository in Git to show me that all my efforts were not in vain!\n",
  "wordCount" : "4539",
  "inLanguage": "en",
  "image":"https://upload.wikimedia.org/wikipedia/commons/f/f3/Apache_Spark_logo.svg","datePublished": "2024-03-04T12:30:57+01:00",
  "dateModified": "2024-03-04T12:30:57+01:00",
  "author":[{
    "@type": "Person",
    "name": "Sem Sinchenko"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/ssinchenko/post/extending-spark-connect/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Sem Sinchenko",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/ssinchenko/images/fav/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/ssinchenko/" accesskey="h" title="Sem Sinchenko (Alt + H)">Sem Sinchenko</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/ssinchenko/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/ssinchenko/page/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/ssinchenko/page/cv/" title="CV">
                    <span>CV</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/ssinchenko/categories" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/ssinchenko/tags" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Extending Spark Connect
    </h1>
    <div class="post-meta"><span title='2024-03-04 12:30:57 +0100 CET'>March 4, 2024</span>&nbsp;·&nbsp;22 min&nbsp;·&nbsp;Sem Sinchenko

</div>
  </header> 
<figure class="entry-cover"><img loading="eager" src="https://upload.wikimedia.org/wikipedia/commons/f/f3/Apache_Spark_logo.svg" alt="">
        
</figure>
  <div class="post-content"><h2 id="preface">Preface<a hidden class="anchor" aria-hidden="true" href="#preface">#</a></h2>
<p>I would like to thank <a href="https://github.com/grundprinzip">Martin Grund</a>. He gave me a lot of useful advice during my work on this project!</p>
<h2 id="introduction">Introduction<a hidden class="anchor" aria-hidden="true" href="#introduction">#</a></h2>
<p>Recently, I published a <a href="https://semyonsinchenko.github.io/ssinchenko/post/how-databricks-14x-breaks-3dparty-compatibility/">post</a> about potential compatibility issues between <code>SparkConnect</code> and 3d-party libraries that depend on <code>py4j</code>. After that post, people from Databricks contacted me and suggested we work together on this issue. With their help, I tried to create a step-by-step guide for newbies on how to extend SparkConnect and how to potentially migrate from <code>py4j</code> logic to writing protocol plugins.</p>
<h3 id="what-is-going-on">What is going on?<a hidden class="anchor" aria-hidden="true" href="#what-is-going-on">#</a></h3>
<p>As you may know, Apache Spark 4.0 is coming. And it looks like the <code>SparkConnect</code> protocol will be the main way of communication between the driver and the user&rsquo;s code. So we need to be ready for it. But there are still a lot of 3d party libraries based on <code>Java</code>/<code>Scala</code> core and <code>PySpark</code> bindings via <code>py4j</code>. There is also a gap in the Apache Spark documentation on how to extend the protocol, what are the best practices, and how to migrate your project to a new way of working.</p>
<h3 id="what-is-spark-connect">What is Spark Connect<a hidden class="anchor" aria-hidden="true" href="#what-is-spark-connect">#</a></h3>
<p>For anyone new to the topic, <code>SparkConnect</code> is a new modern way to make <code>Apache Spark</code> a little more &ldquo;modular&rdquo;. Instead of creating a <code>Driver</code> directly in the user&rsquo;s code, we create a <code>Driver</code> in a remote SparkConnect server. All communication between the client and such a server is done via the <code>gRPC</code> protocol. This opens a lot of interesting possibilities, such as</p>
<ul>
<li>Easy creation of new language APIs, for example the recently introduced <a href="https://github.com/apache/spark-connect-go">Go Spark Client</a>;</li>
<li>Better user isolation when working on shared clusters (like Databricks Shared Clusters);</li>
<li>Reduced dependency hell because users do not have to check all Spark internal dependencies and only need a thin client;</li>
</ul>
<figure>
    <img loading="lazy" src="https://spark.apache.org/docs/latest/img/spark-connect-api.png"/> <figcaption>
            Spark Connect Architecture
        </figcaption>
</figure>

<p>For a top-level overview, you can check out an <a href="https://spark.apache.org/docs/latest/spark-connect-overview.html">Overview in Spark Documentation</a>. For a deeper dive into the topic I recommend this <a href="https://www.waitingforcode.com/apache-spark/what-new-apache-spark-3.4.0-spark-connect/read">nice blog post by Bartosz Konieczny</a> or the video of Martin Grund&rsquo;s presentation:</p>


    
    <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
      <iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen="allowfullscreen" loading="eager" referrerpolicy="strict-origin-when-cross-origin" src="https://www.youtube.com/embed/IbxmZwnzLT0?autoplay=0&controls=1&end=0&loop=0&mute=0&start=0" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" title="YouTube video"
      ></iframe>
    </div>

<h3 id="how-the-post-is-organized">How the post is organized<a hidden class="anchor" aria-hidden="true" href="#how-the-post-is-organized">#</a></h3>
<ul>
<li>The first section will briefly describe how to get and configure everything you need to test a SparkConnect application. Like getting Spark itself, building it from source, fixing some bugs, etc. We will also touch on all the prerequisites needed to build an application: <code>Java</code>, <code>Maven</code>, <code>Python</code>, <code>protobuf</code>, <code>buf</code>, etc;</li>
<li>After that, we will briefly touch on the basic structures provided by <code>Spark</code> for extending the protocol: <code>CommandPlugin</code>, <code>RelationPlugin</code>, <code>ExtensionPlugin</code>;</li>
<li>Next, we will define the <code>JVM</code> library that we want to wrap in the SparkConnect extension;</li>
<li>After that, we will write all the necessary protocol extensions;</li>
<li>The next step is to create a Python client;</li>
<li>Finally, the end2end testing of the application;</li>
<li>At the end I will try to say a few words about what is good in a new <code>SparkConnect</code> and what is missing from my point of view.</li>
</ul>
<h3 id="setup">Setup<a hidden class="anchor" aria-hidden="true" href="#setup">#</a></h3>
<p>In this project I will use <code>Java</code> instead of <code>Scala</code>. The reason is quite simple: in my understanding, any Scala dev can read <code>Java</code> code. But it does not always work well in the other direction just because of <code>Scala</code> magic and implicity. Of course, the same code will look more elegant in <code>Scala</code>, but since this is a blog post, readability should be the first priority. I will also use <code>Maven</code> as a build system, simply because <code>Apache Spark</code> itself uses this build tool.</p>
<p>Before we start, you will need the following</p>
<ul>
<li><code>Java 17</code>: <a href="https://jdk.java.net/archive/">Archive</a> or install it through your system package manager or use <a href="https://sdkman.io/">SDKMan</a>;</li>
<li><code>Python 3.10</code>: <a href="https://www.python.org/downloads/">Archive</a> or install it via the system package manager or use <a href="https://github.com/pyenv/pyenv">PyEnv</a>;</li>
<li><code>Maven</code>: <a href="https://maven.apache.org/download.cgi">Download page</a> or install it via the system package manager;</li>
<li><code>Protobuf</code>: <a href="https://protobuf.dev/downloads/">Release Page</a>, but it is better to install it via the system package manager;</li>
<li><code>Buf</code>: <a href="https://github.com/bufbuild/buf">GitHub repo</a>.</li>
</ul>
<h4 id="build-the-latest-spark">Build the latest Spark<a hidden class="anchor" aria-hidden="true" href="#build-the-latest-spark">#</a></h4>
<p>The main reason to work directly with the latest Spark snapshot is that while the Spark Connect general implementation is readily available since Spark 3.4 for Python and Spark 3.5 for Scala, there is still a lot of work in progress to reduce sharp edges and improve documentation.</p>
<p>We need to work with a latest available <code>spark-4.0.0-SNAPSHOT</code> version. At first you need to clone it locally via <code>git clone git@github.com:apache/spark.git</code>. After that just go inside and call <code>mvn ./build/mvn -Pconnect clean package</code>. The next step is to generate corresponding <code>PySpark</code> library: <code>cd python; python3.10 setup.py sdist</code>. It will generate something like <code>pyspark-4.0.0.dev0.tar.gz</code> in <code>dist</code> folder. It is a ready to use distribution that may be installed into user&rsquo;s environment.</p>
<h2 id="a-jvm-library-example">A JVM library example<a hidden class="anchor" aria-hidden="true" href="#a-jvm-library-example">#</a></h2>
<p>Our goal will be to try to wrap some existing Spark-Java logic that manipulates by instances of <code>DataFrame</code> class and also by own classes. Of course, at first, we need to define such a library first!</p>
<h3 id="command-logic">Command Logic<a hidden class="anchor" aria-hidden="true" href="#command-logic">#</a></h3>
<p>The simplest of all the possible cases is just a command. In the world of Spark Connect, a command is a simple way to invoke server-side logic that might incur a side-effect and does not necessarily return data. On the JVM-side it should be represented by <code>public void command(A argA, B argB, ...)</code>. For example, it may be the case when we need to initialize library classes by something like <code>public void init()</code>. Another case is when we want to write something to the <code>FileSystem</code>. Let&rsquo;s try to mimic such a case:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CommandLikeLogic</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">commandA</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">paramA</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">paramB</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">paramC</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">spark</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SparkSession</span><span class="p">.</span><span class="na">active</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Path</span><span class="p">(</span><span class="n">paramC</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">fs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path</span><span class="p">.</span><span class="na">getFileSystem</span><span class="p">(</span><span class="n">spark</span><span class="p">.</span><span class="na">hadoopConf</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">outputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fs</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">path</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">outputStream</span><span class="p">.</span><span class="na">writeUTF</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&#34;FieldA: %d\nFieldB: %d&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">paramA</span><span class="p">,</span><span class="w"> </span><span class="n">paramB</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">outputStream</span><span class="p">.</span><span class="na">flush</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">outputStream</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>It is a very dummy class with just a single method <code>commandA(Long paramA, Long paramB, String paramC)</code>. It do the following:</p>
<ol>
<li>Get a current active <code>SparkSession</code> object;</li>
<li>Get a right implementation of <code>org.apache.hadoop.fs.FileSystem</code> based on the configuration from the <code>SparkSession</code>;</li>
<li>Write values of <code>paramA</code> and <code>paramB</code> into a file in path defined by <code>paramC</code></li>
</ol>
<p>As one may see there is no magic. But working with underlying <code>org.apache.hadoop.fs.FileSystem</code> is not possible from <code>PySpark</code> and it is very common case to write such a logic in <code>JVM</code>-languages!</p>
<h3 id="dataframe-logic">DataFrame Logic<a hidden class="anchor" aria-hidden="true" href="#dataframe-logic">#</a></h3>
<p>Another case is when <code>JVM</code>-object should create and return <code>DataFrame</code> (<code>Dataset&lt;Row&gt;</code>) object. It is the most common case for any kind of 3d-party library. From my experience developers typically work-around such a logic via <code>py4j</code>:</p>
<ul>
<li><code>DataFrame</code> in <code>PySpark</code> has a private attribute <code>_jdf</code> that represents <code>py4j.java_gateway.JavaObject</code> corresponds to <code>Dataset&lt;Row&gt;</code> in <code>JVM</code>;</li>
<li><code>DataFrame</code> in <code>PySaprk</code> has a constructor that takes <code>py4j.java_gateway.JavaObject</code> and <code>SparkSession</code> and returns <code>pyspark.sql.DataFrame</code>;</li>
</ul>
<p>With <code>SparkConnect</code> this workaround doesn&rsquo;t work anymore, so let&rsquo;s see how we may do it in a new and right way. Let&rsquo;s try to wrap the following simple class:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DataFrameLogic</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Dataset</span><span class="o">&lt;</span><span class="n">Row</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">createDummyDataFrame</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">schema</span><span class="w"> </span><span class="o">=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">StructType</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">StructField</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">DataTypes</span><span class="p">.</span><span class="na">createStructField</span><span class="p">(</span><span class="s">&#34;col1&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">DataTypes</span><span class="p">.</span><span class="na">LongType</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">DataTypes</span><span class="p">.</span><span class="na">createStructField</span><span class="p">(</span><span class="s">&#34;col2&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">DataTypes</span><span class="p">.</span><span class="na">StringType</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">DataTypes</span><span class="p">.</span><span class="na">createStructField</span><span class="p">(</span><span class="s">&#34;col3&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">DataTypes</span><span class="p">.</span><span class="na">BooleanType</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">spark</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SparkSession</span><span class="p">.</span><span class="na">active</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Row</span><span class="o">&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">gen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Random</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">10</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">rows</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">RowFactory</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">gen</span><span class="p">.</span><span class="na">nextLong</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&#34;%d-%d&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">gen</span><span class="p">.</span><span class="na">nextInt</span><span class="p">(),</span><span class="w"> </span><span class="n">gen</span><span class="p">.</span><span class="na">nextLong</span><span class="p">()),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">gen</span><span class="p">.</span><span class="na">nextBoolean</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">spark</span><span class="p">.</span><span class="na">createDataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="n">schema</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>As one may see it is a really dummy object. And, of course, you can do exactly the same in pure <code>PySpark</code> (doesn&rsquo;t matter, with <code>SparkConnect</code> or not). But let&rsquo;s still try to wrap it just to understand how it works. In this case this simple class should be enough for our purposes. In the world of Spark Connect, this DataFrame logic is represented by <code>Relation</code> messages. These messages are declarative transformations that can be arbitrarily nested and are very similar to the standard Spark SQL operations like <code>project</code>, <code>filter</code>, <code>groupBy</code>.</p>
<h3 id="manipulation-of-jvm-objects">Manipulation of JVM objects<a hidden class="anchor" aria-hidden="true" href="#manipulation-of-jvm-objects">#</a></h3>
<p>The most complex and tricky thing is when we need not only call <code>void</code> commands or create/modify <code>DataFrame</code> objects, but create instances of regular <code>JVM</code> classes and calls methods of them. To mimic such a case let&rsquo;s again create a dummy <code>Java</code> class with couple of getter/setter methods, constructor and, for example, custom <code>toString()</code> implementation:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ObjectManipulationLogic</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">strParameter</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">longParameter</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">ObjectManipulationLogic</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">strParameter</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">longParameter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">strParameter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strParameter</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">longParameter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">longParameter</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getStrParameter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">strParameter</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setStrParameter</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">strParameter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">strParameter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strParameter</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="nf">getLongParameter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">longParameter</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setLongParameter</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">longParameter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">longParameter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">longParameter</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">toString</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;ObjectManipulationLogic{&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;strParameter=&#39;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="o">+</span><span class="w"> </span><span class="n">strParameter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="o">+</span><span class="w"> </span><span class="sc">&#39;\&#39;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;, longParameter=&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="o">+</span><span class="w"> </span><span class="n">longParameter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="o">+</span><span class="w"> </span><span class="sc">&#39;}&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>Our class has a public constructor just for simplicity. In reality, of course, it could be more complex with factory methods. But it should be enough for our demo case.</p>
<p>Our class has two fields, corresponding getters/setters, and a custom `toString&rsquo;. In reality, of course, no one will wrap complex JVM logic in SparkConnect. But as you will see in the next sections, there is no fundamental difference in which method is called. So such a class is complex enough for our demo purposes.</p>
<h3 id="defining-protobuf-messages">Defining protobuf messages<a hidden class="anchor" aria-hidden="true" href="#defining-protobuf-messages">#</a></h3>
<p>At first, to start any kind of <code>SparkConnect</code> extending we need to define contracts in the form of <code>protobuf</code> messages that are interpreted by Spark. We decided to use the following three use-cases:</p>
<ol>
<li>Calling a command;</li>
<li>Creating a <code>DataFrame</code>;</li>
<li>Manipulating <code>JVM</code> object.</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-protobuf" data-lang="protobuf"><span class="line"><span class="cl"><span class="n">syntax</span> <span class="o">=</span> <span class="s">&#39;proto3&#39;</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">option</span> <span class="n">java_multiple_files</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">option</span> <span class="n">java_package</span> <span class="o">=</span> <span class="s">&#34;com.ssinchenko.example.proto&#34;</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">CallCommandLikeLogic</span> <span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">int64</span> <span class="n">paramA</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">int64</span> <span class="n">paramB</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">paramC</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">CallDataFrameLogic</span> <span class="p">{}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">CallObjectManipulationLogic</span> <span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">int32</span> <span class="n">objectId</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">bool</span> <span class="n">newObject</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">bool</span> <span class="n">deleteObject</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">methodName</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="k">repeated</span> <span class="kt">string</span> <span class="n">args</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span></code></pre></div><p>Let&rsquo;s go step by step.</p>
<p>The first rows tels us to use <code>proto3</code> (<code>protobuf</code> version 3) syntax, which package is it, which java package is it, etc. There is no special magic, so, just use it as an example for your Spark proto code.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-protobuf" data-lang="protobuf"><span class="line"><span class="cl"><span class="kd">message</span> <span class="nc">CallCommandLikeLogic</span> <span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">int64</span> <span class="n">paramA</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">int64</span> <span class="n">paramB</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">paramC</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span></code></pre></div><p>This message will be used to call a <code>CommandLikeLogic</code> Java class. As you remember, the only static method <code>commandA</code> takes exactly three arguments (<code>Long paramA, Long paramB, String paramC</code>). In <code>protobuf</code> syntax it transforms into <code>int64 paramA</code>, <code>int64 paramB</code> and <code>string paramC</code>. Numbers in proto-syntax means the id of argument in the message, you can read more about it in <a href="https://protobuf.dev/programming-guides/proto3/">the protobuf documentation</a>.</p>
<p>The message for <code>CallDataFrameLogic</code> is even simpler: it is just an empty one, but we still need it for checking the appropriate command.</p>
<p>The last message is quite tricky. To manipulate objects in <code>JVM</code> via <code>gRPC</code> we need at least the following:</p>
<ol>
<li>An ID of the object just to know which one should we touch in <code>JVM</code>;</li>
<li>A flag that we need to create a new object instead of manipulating existing one;</li>
<li>A flag that we need to delete an existing object;</li>
<li>A name of the method we want to call (in the case when we do not want to delete or create an object);</li>
<li>A list of strings-represented arguments;</li>
</ol>
<p>And it gain us the structure of the <code>CallObjectManipulationLogic</code> message:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-protobuf" data-lang="protobuf"><span class="line"><span class="cl"><span class="kd">message</span> <span class="nc">CallObjectManipulationLogic</span> <span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">int32</span> <span class="n">objectId</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">bool</span> <span class="n">newObject</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">bool</span> <span class="n">deleteObject</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">methodName</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="k">repeated</span> <span class="kt">string</span> <span class="n">args</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span></code></pre></div><p>Because in <code>proto3</code> syntax any argument is optional we do not need to mark fields as <code>optional</code> or <code>required</code>. So, all the checking logic is moving to runtime.</p>
<h3 id="generating-classes-and-methods-from-proto-code">Generating Classes and Methods from proto-code<a hidden class="anchor" aria-hidden="true" href="#generating-classes-and-methods-from-proto-code">#</a></h3>
<p>Now we need to generate corresponding Java classes and methods based on the <code>proto3</code> code. Of course you can use something like <code>protoc -I=... -java_out=... ...</code>. But it is not the simplest way. To make it simpler there is a very cool tool named <code>buf</code> (<a href="https://github.com/bufbuild/buf">link to the buf repo in GitHub</a>). I already mentioned this tool in previous sections. With <code>buf</code> generation for all the languages may be done via one command: <code>buf generate</code>. But at first we need to define <code>buf.work.yaml</code> and <code>buf.gen.yaml</code> that should contain the information about which plugins we want to use.</p>
<p><code>buf.work.yaml</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">directories</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">protobuf</span><span class="w">
</span></span></span></code></pre></div><p><code>buf.gen.yaml</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">plugins</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">plugin</span><span class="p">:</span><span class="w"> </span><span class="l">buf.build/protocolbuffers/python:v25.3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">out</span><span class="p">:</span><span class="w"> </span><span class="l">python/spark_connect_example/proto</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">plugin</span><span class="p">:</span><span class="w"> </span><span class="l">buf.build/grpc/python:v1.62.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">out</span><span class="p">:</span><span class="w"> </span><span class="l">python/spark_connect_example/proto</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">plugin</span><span class="p">:</span><span class="w"> </span><span class="l">buf.build/community/nipunn1313-mypy:v3.5.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">out</span><span class="p">:</span><span class="w"> </span><span class="l">python/spark_connect_example/proto</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">plugin</span><span class="p">:</span><span class="w"> </span><span class="l">buf.build/protocolbuffers/java:v25.3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">out</span><span class="p">:</span><span class="w"> </span><span class="l">java</span><span class="w">
</span></span></span></code></pre></div><blockquote>
<p><strong><em>NOTE:</em></strong> You may find a list of available <code>buf</code> plugins <a href="https://buf.build/plugins">here</a>.</p>
</blockquote>
<p>The first one defines the protobuf files directory, the second one defines what should be generated and also where this files should be places. Let&rsquo;s again see on the structure of the project to better understand what&rsquo;s going on:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="p">|</span>- src
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- main
</span></span><span class="line"><span class="cl"><span class="p">|</span>--- java
</span></span><span class="line"><span class="cl"><span class="p">|</span>---- com/ssinchenko/example
</span></span><span class="line"><span class="cl"><span class="p">|</span>----- lib
</span></span><span class="line"><span class="cl"><span class="p">|</span>----- proto <span class="c1"># &lt;- generated from proto Java classes will be here</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>----- server
</span></span><span class="line"><span class="cl"><span class="p">|</span>--- protobuf <span class="c1"># &lt;- proto3 code is here</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>--- python
</span></span><span class="line"><span class="cl"><span class="p">|</span>---- spark_connect_example
</span></span><span class="line"><span class="cl"><span class="p">|</span>----- proto <span class="c1"># &lt;- generated from proto Python classes will be here</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>---- pyproject.toml
</span></span><span class="line"><span class="cl"><span class="p">|</span>--- buf.gen.yaml
</span></span><span class="line"><span class="cl"><span class="p">|</span>--- buf.work.yaml
</span></span><span class="line"><span class="cl"><span class="p">|</span>- pom.xml
</span></span></code></pre></div><p>So, long story short, all that you need from now to generate (or regenerate) all the classes/py-files is to call <code>buf generate</code> from the <code>src/main</code> directory.</p>
<h3 id="commandplugin">CommandPlugin<a hidden class="anchor" aria-hidden="true" href="#commandplugin">#</a></h3>
<p>As I mention already, the case of <code>void</code> command is the simplest one. Let&rsquo;s see how implementation of the <code>CommandPlugin</code> will look for the case of our <code>CommandLikeLogic</code> class:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CommandLikeLogicPlugin</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">CommandPlugin</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">command</span><span class="p">,</span><span class="w"> </span><span class="n">SparkConnectPlanner</span><span class="w"> </span><span class="n">planner</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Any</span><span class="w"> </span><span class="n">commandProto</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">commandProto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Any</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">command</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InvalidProtocolBufferException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">commandProto</span><span class="p">.</span><span class="na">is</span><span class="p">(</span><span class="n">CallCommandLikeLogic</span><span class="p">.</span><span class="na">class</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">commandProto</span><span class="p">.</span><span class="na">unpack</span><span class="p">(</span><span class="n">CallCommandLikeLogic</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CommandLikeLogic</span><span class="p">.</span><span class="na">commandA</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">getParamA</span><span class="p">(),</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getParamB</span><span class="p">(),</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getParamC</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><blockquote>
<p><strong><em>NOTE:</em></strong> In this case <code>CallCommandLikeLogic</code> is exactly the generated by <code>buf</code> class. It contains more than 500 lines of Java code, so I cannot put it here. But you may generate your own to see how it looks like!</p>
</blockquote>
<p>Let&rsquo;s in details on the syntax.</p>
<ul>
<li><code>implements CommandPlugin</code> is just about which interface should we implement;</li>
<li>we always gets <code>byte[]</code> as an input; you may check it the <a href="https://github.com/apache/spark/blob/master/connector/connect/server/src/main/scala/org/apache/spark/sql/connect/planner/SparkConnectPlanner.scala#L206">spark source code</a>;</li>
<li><code>Any</code> in this case not just any class, but <code>proto.Any</code>: <a href="https://protobuf.dev/reference/java/api-docs/com/google/protobuf/Any.html">link to rest API documentation</a>;</li>
<li><code>planner</code> is a spark internal tool that contains a lot of useful things, including <code>SparkSession</code> itself: <code>var = planner.sessionHolder().session();</code>;</li>
<li><code>command.is(...)</code> verifies that the embedded message types is of the class we expect;</li>
<li><code>command.unpack(...)</code> unpack the command into an actual generated Class with methods;</li>
<li>finally we just call our method from out JVM &ldquo;library&rdquo; like class.</li>
</ul>
<h3 id="relationplugin">RelationPlugin<a hidden class="anchor" aria-hidden="true" href="#relationplugin">#</a></h3>
<p>A more tricky case is when we need to return <code>DataFrame</code>. For that case we need to implement <code>RelationPlugin</code>. It requires to override a method <code>transform</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DataFrameLogicPlugin</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">RelationPlugin</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">LogicalPlan</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">relation</span><span class="p">,</span><span class="w"> </span><span class="n">SparkConnectPlanner</span><span class="w"> </span><span class="n">planner</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Any</span><span class="w"> </span><span class="n">relationProto</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">relationProto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Any</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">relation</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InvalidProtocolBufferException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">relationProto</span><span class="p">.</span><span class="na">is</span><span class="p">(</span><span class="n">CallDataFrameLogic</span><span class="p">.</span><span class="na">class</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">DataFrameLogic</span><span class="p">.</span><span class="na">createDummyDataFrame</span><span class="p">().</span><span class="na">logicalPlan</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>As one may see it is quite similar to command but instead of <code>boolean</code> we need to return an <code>Optional&lt;LogicalPlan&gt;</code>. On the <code>JVM</code> side you can easily get this plan by just calling <code>df.logicalPlan()</code> and that&rsquo;s it.</p>
<blockquote>
<p><strong><em>NOTE:</em></strong> You only need to return <code>Optional.empty</code> if the command is not for this handler! In all other cases you must either throw an exception or return an actual <code>LogicalPlan</code>!</p>
</blockquote>
<h3 id="objects-manipulation">Objects Manipulation<a hidden class="anchor" aria-hidden="true" href="#objects-manipulation">#</a></h3>
<p>The most advanced case is when we want to manipulate an object on the <code>JVM</code> side, as it can be done before with <code>py4j</code>. It is a little tricky because we can only use <code>LogicalPlan</code> for interaction between <code>JVM</code> and client! To implement this thing I will use the following:</p>
<ol>
<li>I will use <code>HashMap&lt;Integer, Object&gt;</code> to map all objects to integer IDs;</li>
<li>To generate an ID of the object I will use <code>System.identifyHashCode(obj)</code>;</li>
<li>All communication with the client will be done via <code>LogicalPlan</code>, even error messages can be transported this way;</li>
<li>Inside I will parse an input message and call create, delete object or call methods;</li>
</ol>
<p>To simplify things, I based my code on the assumption that there may be only 100 objects, or that arguments passed by the client are always correct. And of course I have not touched the topic of ID collision. But you can extend this code to achieve all of the above. My goal was just to create a kind of proof of concept, nothing more!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ObjectManipulationLogicPlugin</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">RelationPlugin</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="cm">/** This is a map, that stores link to all the objects. */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span><span class="w"> </span><span class="n">ObjectManipulationLogic</span><span class="o">&gt;</span><span class="w"> </span><span class="n">idsMapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">100</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">ObjectManipulationLogic</span><span class="w"> </span><span class="nf">getObj</span><span class="p">(</span><span class="n">Integer</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">idsMapping</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">id</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="nf">addObj</span><span class="p">(</span><span class="n">ObjectManipulationLogic</span><span class="w"> </span><span class="n">obj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">identityHashCode</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">idsMapping</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">obj</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="n">Integer</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">ObjectManipulationLogic</span><span class="w"> </span><span class="n">obj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">idsMapping</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">obj</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">dropObj</span><span class="p">(</span><span class="n">Integer</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">idsMapping</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">id</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">Dataset</span><span class="o">&lt;</span><span class="n">Row</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getSuccessDF</span><span class="p">(</span><span class="n">SparkSession</span><span class="w"> </span><span class="n">spark</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">spark</span><span class="p">.</span><span class="na">createDataFrame</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">RowFactory</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="s">&#34;success&#34;</span><span class="p">)),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">StructType</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">StructField</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">DataTypes</span><span class="p">.</span><span class="na">createStructField</span><span class="p">(</span><span class="s">&#34;status&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">DataTypes</span><span class="p">.</span><span class="na">StringType</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">LogicalPlan</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">relation</span><span class="p">,</span><span class="w"> </span><span class="n">SparkConnectPlanner</span><span class="w"> </span><span class="n">planner</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// To make the code simpler I&#39;m not checking type of passed from Python arguments!</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// So, the overall logic is build on the assumption, that it is impossible to get</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// from python an invalid string or invalid long.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// It makes sense, because it is x10 simpler to do it on the Python side</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Any</span><span class="w"> </span><span class="n">relationProto</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">relationProto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Any</span><span class="p">.</span><span class="na">parseFrom</span><span class="p">(</span><span class="n">relation</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InvalidProtocolBufferException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">relationProto</span><span class="p">.</span><span class="na">is</span><span class="p">(</span><span class="n">CallObjectManipulationLogic</span><span class="p">.</span><span class="na">class</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="n">spark</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">planner</span><span class="p">.</span><span class="na">sessionHolder</span><span class="p">().</span><span class="na">session</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// We are parsing the message</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">relationProto</span><span class="p">.</span><span class="na">unpack</span><span class="p">(</span><span class="n">CallObjectManipulationLogic</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">getNewObject</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// If we need to create a new object we are doing the following:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// 1. Get args</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// 2. Create an instance</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// 3. Add an id of the instance to the Map</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// 4. Return the id to Python</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="kd">var</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getArgsList</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="kd">var</span><span class="w"> </span><span class="n">paramA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="kd">var</span><span class="w"> </span><span class="n">paramB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Long</span><span class="p">.</span><span class="na">parseLong</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">1</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="kd">var</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectManipulationLogic</span><span class="p">(</span><span class="n">paramA</span><span class="p">,</span><span class="w"> </span><span class="n">paramB</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="kd">var</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ObjectManipulationLogicPlugin</span><span class="p">.</span><span class="na">addObj</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="kd">var</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">spark</span><span class="p">.</span><span class="na">createDataFrame</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">RowFactory</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">id</span><span class="p">)),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="k">new</span><span class="w"> </span><span class="n">StructType</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="k">new</span><span class="w"> </span><span class="n">StructField</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">DataTypes</span><span class="p">.</span><span class="na">createStructField</span><span class="p">(</span><span class="s">&#34;id&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">DataTypes</span><span class="p">.</span><span class="na">IntegerType</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="p">}));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="na">logicalPlan</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">getDeleteObject</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// If we need to drop the object we just delete it from the Map</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// After that GC will do it&#39;s work.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="kd">var</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getObjectId</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">ObjectManipulationLogicPlugin</span><span class="p">.</span><span class="na">dropObj</span><span class="p">(</span><span class="n">id</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// All other cases is when we need to call a method</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="kd">var</span><span class="w"> </span><span class="n">methodName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getMethodName</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="kd">var</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getArgsList</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="kd">var</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getObjectId</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="kd">var</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ObjectManipulationLogicPlugin</span><span class="p">.</span><span class="na">getObj</span><span class="p">(</span><span class="n">id</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// Possible to do the same via Reflection API;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// But to achieve explicitly I&#39;m directly check the method name.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// We need to know types anyway, to return a DataFrame with a right schema.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// So, we are checking all the possible methods and do the following:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// 1. If it is setter than just parse args and modify the obj</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// 2. If it is getter or toString we just wrap the output into DataFrame</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">methodName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="s">&#34;getStrParameter&#34;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="kd">var</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="n">spark</span><span class="p">.</span><span class="na">createDataFrame</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">RowFactory</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">instance</span><span class="p">.</span><span class="na">getStrParameter</span><span class="p">())),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="k">new</span><span class="w"> </span><span class="n">StructType</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                          </span><span class="k">new</span><span class="w"> </span><span class="n">StructField</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">DataTypes</span><span class="p">.</span><span class="na">createStructField</span><span class="p">(</span><span class="s">&#34;strParameter&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">DataTypes</span><span class="p">.</span><span class="na">StringType</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                          </span><span class="p">}));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="na">logicalPlan</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="s">&#34;getLongParameter&#34;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="kd">var</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="n">spark</span><span class="p">.</span><span class="na">createDataFrame</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">RowFactory</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">instance</span><span class="p">.</span><span class="na">getLongParameter</span><span class="p">())),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="k">new</span><span class="w"> </span><span class="n">StructType</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                          </span><span class="k">new</span><span class="w"> </span><span class="n">StructField</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">DataTypes</span><span class="p">.</span><span class="na">createStructField</span><span class="p">(</span><span class="s">&#34;longParameter&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">DataTypes</span><span class="p">.</span><span class="na">LongType</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                          </span><span class="p">}));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="na">logicalPlan</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="s">&#34;setStrParameter&#34;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">instance</span><span class="p">.</span><span class="na">setStrParameter</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">0</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">update</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">instance</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">getSuccessDF</span><span class="p">(</span><span class="n">spark</span><span class="p">).</span><span class="na">logicalPlan</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="s">&#34;setLongParameter&#34;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">instance</span><span class="p">.</span><span class="na">setLongParameter</span><span class="p">(</span><span class="n">Long</span><span class="p">.</span><span class="na">parseLong</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">0</span><span class="p">)));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">update</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">instance</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">getSuccessDF</span><span class="p">(</span><span class="n">spark</span><span class="p">).</span><span class="na">logicalPlan</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="s">&#34;toString&#34;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="kd">var</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="n">spark</span><span class="p">.</span><span class="na">createDataFrame</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">RowFactory</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">instance</span><span class="p">.</span><span class="na">toString</span><span class="p">())),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="k">new</span><span class="w"> </span><span class="n">StructType</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                          </span><span class="k">new</span><span class="w"> </span><span class="n">StructField</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">DataTypes</span><span class="p">.</span><span class="na">createStructField</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                </span><span class="s">&#34;stringRepresentation&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">DataTypes</span><span class="p">.</span><span class="na">StringType</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                          </span><span class="p">}));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="na">logicalPlan</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">default</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="kd">var</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="n">spark</span><span class="p">.</span><span class="na">createDataFrame</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                          </span><span class="n">RowFactory</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&#34;Invalid method name %s&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">methodName</span><span class="p">))),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="k">new</span><span class="w"> </span><span class="n">StructType</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                          </span><span class="k">new</span><span class="w"> </span><span class="n">StructField</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">DataTypes</span><span class="p">.</span><span class="na">createStructField</span><span class="p">(</span><span class="s">&#34;errorMessage&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">DataTypes</span><span class="p">.</span><span class="na">StringType</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                          </span><span class="p">}));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="na">logicalPlan</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// In the case of error we are just wrapping the error message to DataFrame</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">sw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StringWriter</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">pw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PrintWriter</span><span class="p">(</span><span class="n">sw</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">(</span><span class="n">pw</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">spark</span><span class="p">.</span><span class="na">createDataFrame</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">RowFactory</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&#34;IOException %s&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">sw</span><span class="p">))),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">StructType</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">new</span><span class="w"> </span><span class="n">StructField</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="n">DataTypes</span><span class="p">.</span><span class="na">createStructField</span><span class="p">(</span><span class="s">&#34;errorMessage&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">DataTypes</span><span class="p">.</span><span class="na">StringType</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="na">logicalPlan</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// That is the case when the message corresponds to another plugin/extension.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="build-the-project">Build the project<a hidden class="anchor" aria-hidden="true" href="#build-the-project">#</a></h3>
<p>To build the project it is enough just to call <code>mvn clean package</code> and it will create an artifcat like this <code>connect-1.0-SNAPSHOT.jar</code>. Of course, in assumption, that you are using the code of my example <a href="https://github.com/SemyonSinchenko/spark-connect-example/tree/master">from GitHub repository</a>!</p>
<h2 id="sparkconnect-plugins-in-python">SparkConnect Plugins in Python<a hidden class="anchor" aria-hidden="true" href="#sparkconnect-plugins-in-python">#</a></h2>
<p>To setup all the dependencies do the following:</p>
<ol>
<li>Make <code>SPARK_HOME</code> variable points to the place where gou cloned <code>spark</code>. In my case it is <code>export SPARK_HOME=~/github/spark</code>;</li>
<li>In you python project (in my repo it is <code>src/main/python</code>) create virtual environment: <code>python3.10 -m venv .venv</code>;</li>
<li>Install pyspark dependencies: <code>source .venv/bin/activate &amp;&amp; pip install -r ${SPARK_HOME}/dev/requirements.txt</code>;</li>
<li>Install pyspark itself: <code>source .venv/bin/activate &amp;&amp; pip install ${SPARK_HOME}/python/dist/pyspark-4.0.0.dev0.tar.gz</code>.</li>
</ol>
<p>It should be enough to run my example and to make autocomplete works.</p>
<h3 id="implementation-in-python">Implementation in Python<a hidden class="anchor" aria-hidden="true" href="#implementation-in-python">#</a></h3>
<p>If you did not generate needed python-classes that implements <code>protobuf</code> Messages, you can easily do it via <code>buf generate</code> (from <code>src/main</code>).</p>
<p>The next step is to implement a <code>gRPC</code> client.</p>
<h4 id="callcommand">CallCommand<a hidden class="anchor" aria-hidden="true" href="#callcommand">#</a></h4>
<p>Each message kind should be implemented as a separate <code>Python</code> class that inherit from <code>pyspark.sql.connect.plan.LogicalPlan</code>. For command you need to override the <code>command</code> method:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">CallCommandPlan</span><span class="p">(</span><span class="n">LogicalPlan</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_a</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">param_b</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">param_c</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_a</span> <span class="o">=</span> <span class="n">param_a</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="o">=</span> <span class="n">param_b</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_c</span> <span class="o">=</span> <span class="n">param_c</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">SparkConnectClient</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">proto</span><span class="o">.</span><span class="n">Command</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">command</span> <span class="o">=</span> <span class="n">proto</span><span class="o">.</span><span class="n">Command</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">command</span><span class="o">.</span><span class="n">extension</span><span class="o">.</span><span class="n">Pack</span><span class="p">(</span><span class="n">CallCommandLikeLogic</span><span class="p">(</span><span class="n">paramA</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_a</span><span class="p">,</span> <span class="n">paramB</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_b</span><span class="p">,</span> <span class="n">paramC</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">command</span>
</span></span></code></pre></div><p>And after that you can create a function that uses this class. Remember that even if it is just a <code>Command</code>, you still need to call an action on the returned <code>DataFrame</code>!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">call_command</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">spark</span><span class="p">:</span> <span class="n">SparkSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">DataFrame</span><span class="p">(</span><span class="n">CallCommandPlan</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">file_name</span><span class="p">),</span> <span class="n">spark</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</span></span></code></pre></div><h4 id="calldataframe">CallDataFrame<a hidden class="anchor" aria-hidden="true" href="#calldataframe">#</a></h4>
<p>The next in a row is a dummy function that generates <code>DataFrame</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">CallDataFrameLogicPlan</span><span class="p">(</span><span class="n">LogicalPlan</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">SparkConnectClient</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">proto</span><span class="o">.</span><span class="n">Relation</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_proto_relation</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">ext</span> <span class="o">=</span> <span class="n">CallDataFrameLogic</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">plan</span><span class="o">.</span><span class="n">extension</span><span class="o">.</span><span class="n">Pack</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">plan</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">create_dataframe_extension</span><span class="p">(</span><span class="n">spark</span><span class="p">:</span> <span class="n">SparkSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">CallDataFrameLogicPlan</span><span class="p">(),</span> <span class="n">spark</span><span class="p">)</span>
</span></span></code></pre></div><p>Almost like a <code>Command</code> but now you need to override <code>plan</code> method, not <code>command</code>.</p>
<h4 id="objects-manipulation-1">Objects Manipulation<a hidden class="anchor" aria-hidden="true" href="#objects-manipulation-1">#</a></h4>
<p>The most tricky part. As you remember, we used IDs in <code>JVM</code> side to provide a way of interacting between client and java-object. But before we implement a <code>Python</code> wrapper on top of <code>Java</code> object we need to create a <code>LogicalPlan</code> extension:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">CallObjectManipulationPlan</span><span class="p">(</span><span class="n">LogicalPlan</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">object_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_object</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">delete_object</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">method_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">jargs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">jargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">jargs</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_object_id</span> <span class="o">=</span> <span class="n">object_id</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_object</span> <span class="o">=</span> <span class="n">new_object</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_delete_object</span> <span class="o">=</span> <span class="n">delete_object</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_method_name</span> <span class="o">=</span> <span class="n">method_name</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_jargs</span> <span class="o">=</span> <span class="n">jargs</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">SparkConnectClient</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">proto</span><span class="o">.</span><span class="n">Relation</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_proto_relation</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">ext</span> <span class="o">=</span> <span class="n">CallObjectManipulationLogic</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">objectId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_object_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">newObject</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_new_object</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">deleteObject</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_delete_object</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">methodName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_method_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_jargs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">plan</span><span class="o">.</span><span class="n">extension</span><span class="o">.</span><span class="n">Pack</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">plan</span>
</span></span></code></pre></div><p>This class is very similar to our dummy <code>CallDataFrameLogicPlan</code> but not we have an actual constructor with fields.</p>
<p>Let&rsquo;s see, how the <code>Python</code> class corresponds to the <code>Java</code> class may be written:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">JavaLikeObject</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_a</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">param_b</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">spark</span><span class="p">:</span> <span class="n">SparkSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">query_plan</span> <span class="o">=</span> <span class="n">CallObjectManipulationPlan</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">new_object</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">jargs</span><span class="o">=</span><span class="p">[</span><span class="n">param_a</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">param_b</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">query_plan</span><span class="p">,</span> <span class="n">spark</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="s2">&#34;errorMessage&#34;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">err_msg</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">collect</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">asDict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;errorMessage&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">obj_id</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">collect</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">asDict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="n">obj_id</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_spark</span> <span class="o">=</span> <span class="n">spark</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_str_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">query_plan</span> <span class="o">=</span> <span class="n">CallObjectManipulationPlan</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">object_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="n">method_name</span><span class="o">=</span><span class="s2">&#34;getStrParameter&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">DataFrame</span><span class="p">(</span><span class="n">query_plan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spark</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">collect</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">asDict</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;strParameter&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_long_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">query_plan</span> <span class="o">=</span> <span class="n">CallObjectManipulationPlan</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">object_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="n">method_name</span><span class="o">=</span><span class="s2">&#34;getLongParameter&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">DataFrame</span><span class="p">(</span><span class="n">query_plan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spark</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">collect</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">asDict</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;longParameter&#34;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">set_str_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">str_par</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">query_plan</span> <span class="o">=</span> <span class="n">CallObjectManipulationPlan</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">object_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="n">method_name</span><span class="o">=</span><span class="s2">&#34;setStrParameter&#34;</span><span class="p">,</span> <span class="n">jargs</span><span class="o">=</span><span class="p">[</span><span class="n">str_par</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">DataFrame</span><span class="p">(</span><span class="n">query_plan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spark</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">set_long_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">long_par</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">query_plan</span> <span class="o">=</span> <span class="n">CallObjectManipulationPlan</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">object_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">method_name</span><span class="o">=</span><span class="s2">&#34;setLongParameter&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">jargs</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">long_par</span><span class="p">)],</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">DataFrame</span><span class="p">(</span><span class="n">query_plan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spark</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">query_plan</span> <span class="o">=</span> <span class="n">CallObjectManipulationPlan</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">object_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="n">method_name</span><span class="o">=</span><span class="s2">&#34;toString&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">DataFrame</span><span class="p">(</span><span class="n">query_plan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spark</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">collect</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">asDict</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;stringRepresentation&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">query_plan</span> <span class="o">=</span> <span class="n">CallObjectManipulationPlan</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">object_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="n">delete_object</span><span class="o">=</span><span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">DataFrame</span><span class="p">(</span><span class="n">query_plan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spark</span><span class="p">)</span>
</span></span></code></pre></div><p>Here we just cover each of possible method in <code>Java</code> in the corresponding <code>Python</code> method.</p>
<h3 id="end2end-demo">End2end demo<a hidden class="anchor" aria-hidden="true" href="#end2end-demo">#</a></h3>
<p>Let&rsquo;s check the most interesting part: objects manipulation. To do we need to create a <code>main.py</code> file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyspark.sql.connect.session</span> <span class="kn">import</span> <span class="n">SparkSession</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">spark_connect_example.app_plugin</span> <span class="kn">import</span> <span class="n">JavaLikeObject</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="s2">&#34;sc://localhost:15002&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Creating an object</span>
</span></span><span class="line"><span class="cl">    <span class="n">java_like</span> <span class="o">=</span> <span class="n">JavaLikeObject</span><span class="p">(</span><span class="n">param_a</span><span class="o">=</span><span class="s2">&#34;some&#34;</span><span class="p">,</span> <span class="n">param_b</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">spark</span><span class="o">=</span><span class="n">spark</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Call setter</span>
</span></span><span class="line"><span class="cl">    <span class="n">java_like</span><span class="o">.</span><span class="n">set_str_parameter</span><span class="p">(</span><span class="s2">&#34;some&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Call setter</span>
</span></span><span class="line"><span class="cl">    <span class="n">java_like</span><span class="o">.</span><span class="n">set_long_parameter</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Call getter</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">java_like</span><span class="o">.</span><span class="n">get_long_parameter</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Call setter again</span>
</span></span><span class="line"><span class="cl">    <span class="n">java_like</span><span class="o">.</span><span class="n">set_long_parameter</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Check that getter returns a new value</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">java_like</span><span class="o">.</span><span class="n">get_long_parameter</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Call toString</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">java_like</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
</span></span></code></pre></div><h4 id="running-sparconnect-server">Running SparConnect server<a hidden class="anchor" aria-hidden="true" href="#running-sparconnect-server">#</a></h4>
<p>Now we need to do some manipulations in the folder where we cloned <code>spark</code>. For me it was <code>~/github/spark</code>. Or just do something like <code>cd $SPARK_HOME</code>.</p>
<p>Before we can actually check this, we need to have the <code>SparkConnect</code> server up and running. For some unknown reason, a recommended way to build Spark with connect support did not add the Java <code>protobuf</code> library to CP. To fix this, I just got it from <code>Maven Central</code>: <code>wget https://repo1.maven.org/maven2/com/google/protobuf/protobuf-java/3.22.0/protobuf-java-3.22.0.jar</code>.</p>
<p>We also need to copy the built <code>connect-1.0-SNAPSHOT.jar</code> into the same folder as spark. Finally, we need to execute a very long command, so it is better to create a short bash script for it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">./sbin/start-connect-server.sh <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --wait <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --verbose <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --jars connect-1.0-SNAPSHOT.jar,protobuf-java-3.22.0.jar <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --conf spark.connect.extensions.command.classes<span class="o">=</span>com.ssinchenko.example.server.CommandLikeLogicPlugin <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --conf spark.connect.extensions.relation.classes<span class="o">=</span>com.ssinchenko.example.server.DataFrameLogicPlugin,com.ssinchenko.example.server.ObjectManipulationLogicPlugin <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --packages org.apache.spark:spark-connect_2.13:4.0.0-SNAPSHOT
</span></span></code></pre></div><p>Let&rsquo;s see it in details:</p>
<ul>
<li><code>--wait</code> means to wait for the process to exit. Otherwise <code>SparkConnect</code> will run in background;</li>
<li><code>--verbose</code> just add some additional debug information;</li>
<li><code>--jars</code>: we need to pass here our <code>connect-1.0-SNAPSHOT.jar</code>. In my case it was necessary to pass also <code>protobuf-java</code>;</li>
<li><code>--conf spark.connect.extensions.relation.classes=...</code>: we should mention here all the plugins for relations;</li>
<li><code>--conf spark.connect.extensions.relation.classes</code>: the same, but for commands;</li>
<li><code>--packages org.apache.spark:spark-connect_2.13:4.0.0-SNAPSHOT</code>: just tell spark what to run.</li>
</ul>
<p>To run the server, just run the bash script we just made. Another way is to copy this long command into you terminal.</p>
<h4 id="running-an-application">Running an application<a hidden class="anchor" aria-hidden="true" href="#running-an-application">#</a></h4>
<p>After running the server, just go back to our <code>src/main/python</code> and run the command <code>source .venv/bin/activate &amp;&amp; python main.py</code>. You will see something like:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span>
</span></span><span class="line"><span class="cl">ObjectManipulationLogic<span class="o">{</span><span class="nv">strParameter</span><span class="o">=</span><span class="s1">&#39;some&#39;</span>, <span class="nv">longParameter</span><span class="o">=</span>2<span class="o">}</span>
</span></span></code></pre></div><blockquote>
<p><strong><em>NOTE:</em></strong> To see detailed logs from python side, use <code>export SPARK_CONNECT_LOG_LEVEL=debug</code></p>
</blockquote>
<p>Anyway, as you can see, our workaround to call <code>JVM</code> from <code>PySpark</code>-connect thin client works!</p>
<p>🥳🥳🥳🥳🥳🥳🥳🥳</p>
<h2 id="discussion">Discussion<a hidden class="anchor" aria-hidden="true" href="#discussion">#</a></h2>
<h3 id="what-was-cool">What was cool?<a hidden class="anchor" aria-hidden="true" href="#what-was-cool">#</a></h3>
<p>I found that having a built-in way to serialize and deserialize <code>LogicalPlan</code> is very cool! It opens up a lot of possibilities for what you can do with SparkConnect! By packing everything into <code>DataFrame</code> and unpacking it on the client side, you can pass almost anything. I guess you could even serialize code into binary format and pack it into <code>DataFrame</code>. Of course, this might look a little crazy, but no more crazy than the magic of <code>py4j</code>!</p>
<h3 id="what-seems-to-be-missing">What seems to be missing<a hidden class="anchor" aria-hidden="true" href="#what-seems-to-be-missing">#</a></h3>
<h4 id="test-environment">Test environment<a hidden class="anchor" aria-hidden="true" href="#test-environment">#</a></h4>
<p>There is no easy way to test your application against SparkConnect. You always have to get binaries, and that is not cool. Even if you need to work with the <code>3.5.x</code> version, you always have to download both binaries and <code>PySpark</code>, which means you download all <code>jar</code> files twice. It would be very cool if we had a simpler way.</p>
<h4 id="error-messages">Error messages<a hidden class="anchor" aria-hidden="true" href="#error-messages">#</a></h4>
<p>Error messages from <code>SparkConnect</code> are still sometimes not informative enough. For example, you might get something like <code>org.apache.spark.sql.connect.common.InvalidPlanInput: No handler found for extension</code> and it is not at all obvious what the reason is and on which message it happened. Is the problem in the <code>Java</code> plugin implementation? Or maybe there is a problem in the <code>Python</code> serialization? Or is it just a missing plugin class in CP? Unfortunately, you have to check all these cases, because the error message says almost nothing.</p>
<h2 id="afterword">Afterword<a hidden class="anchor" aria-hidden="true" href="#afterword">#</a></h2>
<p>I hope my example will help you in your research and development!</p>
<p>P.S. If you find this guide useful, it is not necessary to buy me coffee or anything like that. Just go and star the <a href="https://github.com/SemyonSinchenko/spark-connect-example/tree/master">corresponding repository</a> in Git to show me that all my efforts were not in vain!</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/ssinchenko/tags/spark/">Spark</a></li>
      <li><a href="http://localhost:1313/ssinchenko/tags/pyspark/">Pyspark</a></li>
      <li><a href="http://localhost:1313/ssinchenko/tags/spark-connect/">Spark-Connect</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/ssinchenko/post/effective_feature_store_pyspark/">
    <span class="title">« Prev</span>
    <br>
    <span>Computing ML Feature Store in PySpark</span>
  </a>
  <a class="next" href="http://localhost:1313/ssinchenko/post/multiple-spark-versions-with-maven/">
    <span class="title">Next »</span>
    <br>
    <span>Supporting multiple Apache Spark versions with Maven</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Extending Spark Connect on x"
            href="https://x.com/intent/tweet/?text=Extending%20Spark%20Connect&amp;url=http%3a%2f%2flocalhost%3a1313%2fssinchenko%2fpost%2fextending-spark-connect%2f&amp;hashtags=spark%2cpyspark%2cspark-connect">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Extending Spark Connect on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fssinchenko%2fpost%2fextending-spark-connect%2f&amp;title=Extending%20Spark%20Connect&amp;summary=Extending%20Spark%20Connect&amp;source=http%3a%2f%2flocalhost%3a1313%2fssinchenko%2fpost%2fextending-spark-connect%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Extending Spark Connect on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fssinchenko%2fpost%2fextending-spark-connect%2f&title=Extending%20Spark%20Connect">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Extending Spark Connect on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fssinchenko%2fpost%2fextending-spark-connect%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Extending Spark Connect on whatsapp"
            href="https://api.whatsapp.com/send?text=Extending%20Spark%20Connect%20-%20http%3a%2f%2flocalhost%3a1313%2fssinchenko%2fpost%2fextending-spark-connect%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Extending Spark Connect on telegram"
            href="https://telegram.me/share/url?text=Extending%20Spark%20Connect&amp;url=http%3a%2f%2flocalhost%3a1313%2fssinchenko%2fpost%2fextending-spark-connect%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Extending Spark Connect on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Extending%20Spark%20Connect&u=http%3a%2f%2flocalhost%3a1313%2fssinchenko%2fpost%2fextending-spark-connect%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="http://localhost:1313/ssinchenko/">Sem Sinchenko</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
